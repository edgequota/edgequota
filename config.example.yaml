# EdgeQuota Configuration Example
# Copy to /etc/edgequota/config.yaml or set EDGEQUOTA_CONFIG_FILE.

server:
  address: ":8080"
  read_timeout: "30s"
  write_timeout: "30s"
  idle_timeout: "120s"
  drain_timeout: "30s"
  # max_websocket_conns_per_key: 100   # Max concurrent WS connections per rate-limit key (0=unlimited)
  # Optional TLS termination. Required for HTTP/3.
  # Certificates are hot-reloaded when the file changes on disk.
  # tls:
  #   enabled: true
  #   cert_file: "/etc/edgequota/tls/cert.pem"
  #   key_file: "/etc/edgequota/tls/key.pem"
  #   http3_enabled: true   # Serve HTTP/3 (QUIC) on the same address over UDP
  #   min_version: "1.2"    # Minimum TLS version: "1.2" (default) or "1.3"

admin:
  address: ":9090"
  read_timeout: "5s"
  write_timeout: "10s"
  idle_timeout: "30s"

backend:
  # Default backend URL. Required unless rate_limit.external is enabled, in
  # which case the external service can provide per-tenant backend URLs via the
  # "backend_url" field in the GetLimits response. When both are set, the
  # external service's backend_url takes precedence for that request.
  url: "http://my-backend:8080"
  timeout: "30s"
  max_idle_conns: 100
  idle_conn_timeout: "90s"
  # tls_insecure_skip_verify: false

  # ── Backend URL Policy ─────────────────────────────────────────────
  # Controls which dynamic backend URLs (from the external rate-limit service)
  # are allowed. IMPORTANT: When using backend_url overrides from the external
  # RL service, set allowed_hosts to restrict where traffic can be routed.
  # If the external RL service is compromised, any allowlist it returns is
  # equally untrustworthy — the ONLY defensible enforcement point is this
  # static configuration. The allowlist is optional but strongly recommended.
  #
  # url_policy:
  #   allowed_schemes:         # Restrict URL scheme. Default: ["http", "https"].
  #     - "http"
  #     - "https"
  #   deny_private_networks: true  # Block RFC 1918, loopback, link-local, cloud metadata IPs. Default: true.
  #   allowed_hosts:           # Optional host allowlist. When non-empty, only these hosts are permitted.
  #     - "backend-a.internal"
  #     - "backend-b.internal"

  # Low-level HTTP transport tuning. All values have sensible defaults.
  transport:
    dial_timeout: "30s"             # TCP dial timeout for backend connections
    dial_keep_alive: "30s"          # TCP keep-alive interval
    tls_handshake_timeout: "10s"    # TLS handshake timeout
    expect_continue_timeout: "1s"   # Expect: 100-continue timeout
    h2_read_idle_timeout: "30s"     # HTTP/2 read idle timeout (gRPC)
    h2_ping_timeout: "15s"          # HTTP/2 ping timeout (gRPC)
    websocket_dial_timeout: "10s"   # WebSocket backend dial timeout

# ─── External Authentication ──────────────────────────────────────────
# Forwards every incoming request to an external auth service BEFORE rate
# limiting. The auth service decides allow/deny and can inject response
# headers and status codes.
#
# Exactly one of auth.http or auth.grpc must be configured when enabled.

# Example A — HTTP auth (most common):
# auth:
#   enabled: true
#   timeout: "5s"
#   failure_policy: "failclosed"     # failclosed (default) | failopen
#   propagate_request_body: false    # Include request body in auth check (default: false)
#   max_auth_body_size: 65536        # Max body bytes sent to auth service (default: 64 KiB)
#   http:
#     url: "http://auth-service:8080/check"
#     forward_original_headers: false # Also send headers as X-Original-*
#   header_filter:
#     deny_list:                      # Headers never forwarded to auth service
#       - "Cookie"                    # (Authorization, Cookie, etc. are forwarded
#       - "Set-Cookie"               #  by default unless explicitly denied)
#     # allow_list: []               # Exclusive: only forward these headers
#                                    #  (deny_list is ignored when allow_list is set)

# Example B — gRPC auth (uses edgequota.auth.v1.AuthService/Check):
# auth:
#   enabled: true
#   timeout: "5s"
#   failure_policy: "failclosed"
#   grpc:
#     address: "auth-service:50051"
#     tls:
#       enabled: true
#       ca_file: "/etc/edgequota/tls/auth-ca.pem"
#       server_name: ""  # Override TLS server name verification. Empty = use hostname from address.

# ─── Rate Limiting ────────────────────────────────────────────────────
rate_limit:
  average: 100          # Requests per period (0 = disabled).
  burst: 50             # Maximum burst capacity.
  period: "1s"
  failure_policy: "passThrough"  # passThrough | failClosed | inMemoryFallback
  # failure_code: 429   # HTTP status for failClosed rejections (must be 4xx/5xx).
  # min_ttl: ""         # Optional floor for Redis key TTL (e.g. "10s"). Reduces EXPIRE churn.
  key_strategy:
    type: "clientIP"    # clientIP | header | composite
    # header_name: "X-Tenant-Id"
    # path_prefix: false
    # trusted_proxies:   # CIDRs whose X-Forwarded-For / X-Real-IP are trusted.
    #   - "10.0.0.0/8"  # When empty (default), only RemoteAddr is used.
    # trusted_ip_depth: 0  # Which XFF entry to use: 0=leftmost, N=Nth from right.

  # ─── External Rate Limit Service (optional) ───────────────────────
  # Queries an external service for per-request rate limits. Enables
  # multi-tenant scenarios where different tenants have different quotas
  # stored in a backend database. Static config values (average/burst/period)
  # are used as fallback when the external service is unreachable.
  #
  # Exactly one of external.http or external.grpc must be configured.

  # Example A — HTTP external limits service:
  # external:
  #   enabled: true
  #   timeout: "5s"
  #   cache_ttl: "60s"                # Default cache TTL when response has no cache hints
  #   max_concurrent_requests: 50     # Semaphore cap on concurrent external calls
  #   http:
  #     url: "http://limits-service:8080/limits"
  #   header_filter:
  #     allow_list:                   # Only forward these headers to the limits service
  #       - "X-Tenant-Id"
  #       - "X-Plan"

  # Example B — gRPC external limits service
  #             (uses edgequota.ratelimit.v1.RateLimitService/GetLimits):
  # external:
  #   enabled: true
  #   timeout: "5s"
  #   cache_ttl: "60s"
  #   max_concurrent_requests: 50
  #   grpc:
  #     address: "limits-service:50052"
#     tls:
#       enabled: true
#       ca_file: "/etc/edgequota/tls/limits-ca.pem"
#       server_name: ""  # Override TLS server name verification. Empty = use hostname from address.

# ─── Redis ────────────────────────────────────────────────────────────
redis:
  endpoints:
    - "redis:6379"
  mode: "single"        # single | replication | sentinel | cluster
  pool_size: 10
  dial_timeout: "5s"
  read_timeout: "3s"
  write_timeout: "3s"

# Optional dedicated Redis for external rate-limit response caches.
# If omitted, the main redis connection above is reused.
# cache_redis:
#   endpoints:
#     - "cache-primary:6379"
#     - "cache-replica-1:6379"
#   mode: "replication"
#   pool_size: 20

logging:
  level: "info"
  format: "json"

# Optional OpenTelemetry tracing.
# tracing:
#   enabled: true
#   endpoint: "http://otel-collector:4318"
#   service_name: "edgequota"
#   sample_rate: 0.1
