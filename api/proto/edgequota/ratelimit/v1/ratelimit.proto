// EdgeQuota Rate Limit Service API
//
// External rate limit services must implement this gRPC service.
// EdgeQuota calls GetLimits() to fetch dynamic per-key rate limits
// when the external rate limit feature is enabled.
//
// Proto definitions are published on the Buf Schema Registry:
//   buf.build/edgequota/edgequota
//
// Generate Go client/server stubs:
//   buf generate

syntax = "proto3";

package edgequota.ratelimit.v1;

option go_package = "github.com/edgequota/edgequota/api/gen/edgequota/ratelimit/v1;ratelimitv1";

// RateLimitService provides dynamic rate limit configuration.
service RateLimitService {
  // GetLimits returns the rate limit parameters for a given key.
  rpc GetLimits(GetLimitsRequest) returns (GetLimitsResponse);
}

// GetLimitsRequest identifies the client and context for limit lookup.
message GetLimitsRequest {
  // Rate limit bucket key (e.g. tenant ID, client IP).
  string key = 1;
  // Flattened request headers for context.
  map<string, string> headers = 2;
  // HTTP method.
  string method = 3;
  // Request path.
  string path = 4;
}

// FailurePolicy controls EdgeQuota's behaviour when Redis is unavailable.
// The external rate-limit service can override the static config on a per-
// request basis by returning one of these values.
enum FailurePolicy {
  // FAILURE_POLICY_UNSPECIFIED means "no override — use static config."
  FAILURE_POLICY_UNSPECIFIED = 0;
  // Let all requests through without rate limiting.
  FAILURE_POLICY_PASSTHROUGH = 1;
  // Deny all requests with the configured (or overridden) failure_code.
  FAILURE_POLICY_FAIL_CLOSED = 2;
  // Fall back to a local in-memory token-bucket limiter.
  FAILURE_POLICY_IN_MEMORY_FALLBACK = 3;
}

// GetLimitsResponse contains the rate limit parameters and optional cache
// control directives. These fields allow the external service to control how
// long EdgeQuota caches this response — consistent across HTTP and gRPC.
//
// For HTTP responses, standard Cache-Control / Expires headers take precedence
// over these body fields. When no HTTP cache headers are present, the body
// fields are used. For gRPC, these body fields are the only way to control
// cache behaviour.
message GetLimitsResponse {
  // Maximum number of requests per period (0 = unlimited).
  int64 average = 1;
  // Maximum burst size.
  int64 burst = 2;
  // Duration string (e.g. "1s", "1m").
  string period = 3;

  // Tenant key for Redis bucket isolation (optional). When non-empty,
  // EdgeQuota uses this as the rate-limit key instead of the extracted key.
  // This allows the external service to assign per-tenant buckets.
  string tenant_key = 6;

  // Dynamic failure policy override (optional). When Redis is unavailable,
  // EdgeQuota normally applies the static failure_policy from config. These
  // fields let the external service override that decision per-request.
  //
  // Example: during planned Redis maintenance, return FAILURE_POLICY_PASSTHROUGH
  // so users are not blocked. During an active attack, return
  // FAILURE_POLICY_FAIL_CLOSED to deny all traffic.

  // Override failure policy. FAILURE_POLICY_UNSPECIFIED (0) = use static config.
  FailurePolicy failure_policy = 7;
  // Override HTTP status code for FAIL_CLOSED policy (e.g. 503). 0 = use
  // static config.
  int32 failure_code = 8;

  // Backend URL override (optional). When non-empty, EdgeQuota proxies this
  // request to the given URL instead of the static backend.url from config.
  // This enables per-tenant backend routing — the external service can direct
  // each tenant's traffic to a different upstream.
  string backend_url = 9;

  // Per-request timeout override (optional). Duration string (e.g. "10s").
  // When non-empty, overrides the global server.request_timeout for this
  // request. This enables per-tenant timeout differentiation.
  optional string request_timeout = 10;

  // Cache control (optional). When omitted, the configured default TTL is used.

  // Cache duration in seconds. When present and > 0, overrides the default
  // cache TTL. A value of 0 with cache_no_store=false is treated as "not set".
  optional int64 cache_max_age_seconds = 4;
  // If true, the response must not be cached.
  bool cache_no_store = 5;
}
